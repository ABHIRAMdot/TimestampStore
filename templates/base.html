<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}TimeStamp - Premium Watches{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a1a1a',
                        secondary: '#d4af37',
                        accent: '#f5f5f5'
                    },
                    fontFamily: {
                        'sans': ['Inter', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .hero-bg {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), 
                        url('https://images.unsplash.com/photo-1523170335258-f5ed11844a49?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1780&q=80');
            background-size: cover;
            background-position: center;
        }
        .watch-card {
            transition: transform 0.3s ease;
        }
        .watch-card:hover {
            transform: translateY(-5px);
        }
        
        /* Toast notification styles */
        .toast {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }


/* ðŸ”¥ Toast Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-10px); }
  to   { opacity: 1; transform: translateY(0); }
}
@keyframes fadeOut {
  from { opacity: 1; transform: translateY(0); }
  to   { opacity: 0; transform: translateY(-10px); }
}
.animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
.animate-fade-out { animation: fadeOut 0.4s ease-out forwards; }



    </style>
    {% block extra_css %}{% endblock %}
</head>

<body class="font-sans bg-white text-primary">
    {% include 'includes/navbar.html' %}
    
    <!-- Django Messages as Toast Notifications -->
    {% if messages %}
        <div class="fixed top-20 right-4 z-50 space-y-3" id="messageContainer">
            {% for message in messages %}
                <div class="toast max-w-md bg-white shadow-lg rounded-lg pointer-events-auto flex items-start p-4 border-l-4 
                    {% if message.tags == 'error' %}border-red-500
                    {% elif message.tags == 'success' %}border-green-500
                    {% elif message.tags == 'warning' %}border-yellow-500
                    {% else %}border-blue-500{% endif %}"
                    role="alert">
                    <div class="flex-shrink-0">
                        {% if message.tags == 'error' %}
                            <i class="fas fa-exclamation-circle text-red-500 text-xl"></i>
                        {% elif message.tags == 'success' %}
                            <i class="fas fa-check-circle text-green-500 text-xl"></i>
                        {% elif message.tags == 'warning' %}
                            <i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>
                        {% else %}
                            <i class="fas fa-info-circle text-blue-500 text-xl"></i>
                        {% endif %}
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm font-medium text-gray-900">
                            {{ message }}
                        </p>
                    </div>
                    <button onclick="this.parentElement.remove()" class="ml-4 flex-shrink-0 text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            {% endfor %}
        </div>
        <script>
            // Auto-dismiss messages after 5 seconds
            setTimeout(() => {
                const container = document.getElementById('messageContainer');
                if (container) {
                    container.style.transition = 'opacity 0.3s';
                    container.style.opacity = '0';
                    setTimeout(() => container.remove(), 300);
                }
            }, 5000);
        </script>
    {% endif %}

    {% block content %}
    {% endblock %}

    {% include 'includes/footer.html' %}
    
    {% block extra_js %}{% endblock %}
    
    <div id="toastContainer" class="fixed top-5 right-5 z-50 space-y-3"></div>
    <!-- Toast Notification -->
<div id="toast"
class="hidden fixed top-5 right-5 px-4 py-3 rounded-lg shadow-lg text-white text-sm z-50">
</div>

<script>
  //  Toast Function (Global)
  function showToast(message, type = "success") {
    const container = document.getElementById("toastContainer");

    const toast = document.createElement("div");
    toast.className = `
      flex items-center gap-3 px-5 py-3 rounded-xl shadow-lg text-white animate-fade-in 
      ${type === "success" ? "bg-green-600" : "bg-red-600"}
    `;
    
    toast.innerHTML = `<span class="font-medium">${message}</span>`;

    container.appendChild(toast);

    setTimeout(() => {
      toast.classList.add("animate-fade-out");
      setTimeout(() => toast.remove(), 400);
    }, 2500);
  }
</script>



<script>
    function updateWishlistCount() {
        fetch("{% url 'get_wishlist_count' %}")
        .then(res => res.json())
        .then(data => {
            const wishlistLink = document.querySelector('a[href*="wishlist"]');
            if (wishlistLink) {
                let badge = wishlistLink.querySelector('.badge');
                if (data.count > 0) {
                    if (!badge) {
                        badge = document.createElement('span');
                        badge.className = 'absolute -top-2 -right-2 bg-red-600 text-white text-xs px-2 py-0.5 rounded-full';
                        wishlistLink.appendChild(badge);
                    }
                    badge.textContent = data.count;
                } else {
                    if (badge) badge.remove();
                }
            }
        });
    }
    </script>
    
    
    <script>
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    cookie = cookie.trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // TOGGLE WISHLIST
        function toggleWishlistFromGrid(event, button) {
            event.stopPropagation();       // ðŸ”¥ prevents opening product detail page
            event.preventDefault();        // ðŸ”¥ prevents link default action
            
            const productId = button.dataset.productId;
            const variantId = button.dataset.variantId;
            const heartIcon = button.querySelector(".wishlist-heart");

            fetch("{% url 'toggle_wishlist' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": getCookie("csrftoken"),
                },
                body: `product_id=${productId}&variant_id=${variantId}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    updateHeartUIFromGrid(heartIcon, data.in_wishlist);
                    showToast(data.message, data.in_wishlist ? "success" : "error");
                    updateWishlistCount();
                } else {
                    showToast(data.message, "error");
                }
            })
            .catch(() => showToast("Something went wrong", "error"));
        }

        
        // HEART ICON UI UPDATE
        function updateHeartUIFromGrid(icon, inWishlist) {
            if (inWishlist) {
                icon.setAttribute("fill", "currentColor");
                icon.setAttribute("stroke", "none");
                icon.classList.add("text-red-500");
        
                // animation
                icon.classList.add("scale-125");
                setTimeout(() => icon.classList.remove("scale-125"), 200);
        
            } else {
                icon.setAttribute("fill", "none");
                icon.setAttribute("stroke", "currentColor");
                icon.classList.remove("text-red-500");
            }
        }
        
        // AUTO LOAD WISHLIST STATUS
        document.addEventListener("DOMContentLoaded", () => {
            document.querySelectorAll("button[data-product-id]").forEach(btn => {
                const productId = btn.dataset.productId;
                const variantId = btn.dataset.variantId;
                const icon = btn.querySelector(".wishlist-heart");
        
                fetch(`{% url 'check_wishlist_status' %}?product_id=${productId}&variant_id=${variantId}`)
                .then(res => res.json())
                .then(data => updateHeartUIFromGrid(icon, data.in_wishlist));
            });
        });
        
        // UPDATE WISHLIST COUNT IN NAV
        function updateWishlistCount() {
            fetch("{% url 'get_wishlist_count' %}")
            .then(res => res.json())
            .then(data => {
                const wishlistLink = document.querySelector("a[href*='wishlist']");
                if (!wishlistLink) return;
        
                let badge = wishlistLink.querySelector(".wishlist-badge");
        
                if (data.count > 0) {
                    if (!badge) {
                        badge = document.createElement("span");
                        badge.className = "wishlist-badge absolute -top-1 -right-1 bg-red-600 text-white text-xs px-2 py-0.5 rounded-full";
                        wishlistLink.appendChild(badge);
                    }
                    badge.textContent = data.count;
                } else if (badge) {
                    badge.remove();
                }
            });
        }
        
        // SHOW TOAST
        function showToast(message, type) {
            const toast = document.getElementById("toast");
        
            toast.textContent = message;
            toast.className = "fixed top-5 right-5 px-4 py-3 rounded-lg shadow-lg text-white text-sm z-50";
        
            if (type === "success") {
                toast.classList.add("bg-green-600");
            } else {
                toast.classList.add("bg-red-600");
            }
        
            toast.classList.remove("hidden", "opacity-0");
            toast.classList.add("opacity-100");
        
            setTimeout(() => {
                toast.classList.add("opacity-0");
                setTimeout(() => toast.classList.add("hidden"), 300);
            }, 2500);
        }
        </script>
        




<script>
    document.addEventListener("DOMContentLoaded", () => {
        document.querySelectorAll("button[data-product-id]").forEach(btn => {
            const productId = btn.dataset.productId;
            const variantId = btn.dataset.variantId;
            const icon = btn.querySelector('.wishlist-heart');
    
            fetch(`{% url 'check_wishlist_status' %}?product_id=${productId}&variant_id=${variantId}`)
            .then(res => res.json())
            .then(data => updateHeartUIFromGrid(icon, data.in_wishlist));
        });
    });
    </script>

<script>
    /* Helper to format amount (simple) */
    function formatCurrency(value) {
        // value likely a string from JSON; ensure two decimals
        const num = Number(value);
        return "â‚¹" + num.toFixed(2);
    }
    
    /* Update page DOM after server response */
    function updateCartDOMAfterQty(resp) {
        if (resp.removed) {
            const el = document.getElementById('cart-item-' + resp.cart_item_id);
            if (el) el.remove();
        } else {
            // update qty and subtotal if present
            if (resp.new_quantity !== undefined) {
                const qEl = document.getElementById('qty-display-' + resp.cart_item_id);
                if (qEl) qEl.textContent = resp.new_quantity;

                // Update item count in summary
            // const countEl = document.getElementById('summary-item-count');
            // if (countEl) countEl.textContent = `Subtotal (${resp.cart_count} items)`;

                if (resp.subtotal_before_discount !== undefined) {
                    const subEl = document.getElementById('summary-subtotal');
                    if (subEl) subEl.textContent = formatCurrency(resp.subtotal_before_discount);
                }


            }
            if (resp.item_subtotal !== undefined) {
                const sEl = document.getElementById('item-subtotal-' + resp.cart_item_id);
                if (sEl){

                 sEl.textContent = formatCurrency(resp.item_subtotal);
                }
            }

            if (resp.cart_savings !== undefined) {
                const saveEl = document.getElementById('summary-savings');
                if (saveEl) saveEl.textContent = formatCurrency(resp.cart_savings);
            }


            // Update MRP subtotal UI
            if (resp.original_price !== undefined) {
                const mrpEl = document.getElementById('mrp-' + resp.cart_item_id);
                if (mrpEl) mrpEl.textContent =
                    `â‚¹${resp.original_price}`;
            }


            // Update discount amount UI
            if (resp.discount_amount !== undefined && resp.discount_percentage !== undefined) {
                const disEl = document.getElementById('discount-' + resp.cart_item_id);
                if (disEl) disEl.textContent =
                    `Save â‚¹${resp.discount_amount}`;
            }


        }


        // Update cart total displayed on summary
        const totalEls = document.querySelectorAll('[data-cart-total]');
        totalEls.forEach(e => e.textContent = formatCurrency(resp.cart_total));
    
        // Update cart_count in various places
        updateCartCountUI(resp.cart_count);
    }
    
    /* Update cart count in navbar */
    function updateCartCountUI(count) {
        // try element with id 'cart-count' or anchor badge
        const cartCountEl = document.getElementById('cart-count');
        if (cartCountEl) {
            cartCountEl.textContent = count;
        }
        // call your existing updateWishlistCount if needed
        // fallback: fetch get_cart_count endpoint
    }
    
    /* AJAX: increase / decrease */
    function updateQtyAjax(cart_item_id, action, btn) {
        btn.disabled = true;
        const formData = new URLSearchParams();
        formData.append('cart_item_id', cart_item_id);
        formData.append('action', action);
    
        fetch("{% url 'update_cart_quantity_ajax' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCookie('csrftoken')
            },
            body: formData.toString()
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                updateCartDOMAfterQty(data);
                showToast(data.message, "success");
            } else {
                // If server removed the item, it returns removed + message
                if (data.removed) {
                    updateCartDOMAfterQty(data);
                    showToast(data.message, "warning");
                } else {
                    showToast(data.message || "Could not update quantity", "error");
                }
            }
        })
        .catch(() => showToast("An error occurred. Please try again.", "error"))
        .finally(() => { btn.disabled = false; });
    }
    
    /* Remove modal & action */
    let _modalTargetItemId = null;
    function confirmRemoveModal(cart_item_id, product_name) {
        _modalTargetItemId = cart_item_id;
        document.getElementById('confirmModalTitle').textContent = "Remove item";
        document.getElementById('confirmModalMessage').textContent = `Remove "${product_name}" from cart?`;
        document.getElementById('confirmModalActionBtn').textContent = "Remove";
        document.getElementById('confirmModalActionBtn').onclick = performRemoveAjax;
        document.getElementById('confirmModal').classList.remove('hidden');
        document.getElementById('confirmModal').classList.add('flex');
    }
    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.add('hidden');
        document.getElementById('confirmModal').classList.remove('flex');
        _modalTargetItemId = null;
    }
    function performRemoveAjax() {
        if (!_modalTargetItemId) return closeConfirmModal();
        const formData = new URLSearchParams();
        formData.append('cart_item_id', _modalTargetItemId);
    
        const btn = document.getElementById('confirmModalActionBtn');
        btn.disabled = true;
    
        fetch("{% url 'remove_from_cart_ajax' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCookie('csrftoken')
            },
            body: formData.toString()
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // remove DOM
                const el = document.getElementById('cart-item-' + data.cart_item_id);
                if (el) el.remove();
    
                // update totals
                document.querySelectorAll('[data-cart-total]').forEach(e => e.textContent = formatCurrency(data.cart_total));
                updateCartCountUI(data.cart_count);


                // ðŸ”¥ Add summary subtotal update
                const subEl = document.getElementById('summary-subtotal');
                if (subEl) subEl.textContent = formatCurrency(data.subtotal_before_discount);

                // ðŸ”¥ Add savings update
                const saveEl = document.getElementById('summary-savings');
                if (saveEl) saveEl.textContent = formatCurrency(data.cart_savings);

    
                showToast(data.message, "success");
            } else {
                showToast(data.message || "Could not remove item", "error");
            }
        })
        .catch(() => showToast("An error occurred. Please try again.", "error"))
        .finally(() => {
            btn.disabled = false;
            closeConfirmModal();
        });
    }
    
    /* Clear cart with confirmation */
    function confirmClearCart() {
        document.getElementById('confirmModalTitle').textContent = "Clear cart";
        document.getElementById('confirmModalMessage').textContent = "Clear all items from your cart?";
        document.getElementById('confirmModalActionBtn').textContent = "Clear Cart";
        document.getElementById('confirmModalActionBtn').onclick = performClearCartAjax;
        document.getElementById('confirmModal').classList.remove('hidden');
        document.getElementById('confirmModal').classList.add('flex');
    }
    function performClearCartAjax() {
        const btn = document.getElementById('confirmModalActionBtn');
        btn.disabled = true;
    
        fetch("{% url 'clear_cart_ajax' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": getCookie('csrftoken')
            },
            body: ""
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // remove all cart items from DOM
                document.querySelectorAll("[id^='cart-item-']").forEach(n => n.remove());
                document.querySelectorAll('[data-cart-total]').forEach(e => e.textContent = formatCurrency(data.cart_total));
                updateCartCountUI(data.cart_count);

                //  Add summary subtotal update
                const subEl = document.getElementById('summary-subtotal');
                if (subEl) subEl.textContent = formatCurrency(data.subtotal_before_discount);

                //  Add savings update
                const saveEl = document.getElementById('summary-savings');
                if (saveEl) saveEl.textContent = formatCurrency(data.cart_savings);

                    // Refresh page after clear(time 300 ms for toast to appear)
                setTimeout(() => location.reload(), 500);

                showToast(data.message, "success");


            } else {
                showToast(data.message || "Could not clear cart", "error");
            }
        })
        .catch(() => showToast("An error occurred. Please try again.", "error"))
        .finally(() => {
            btn.disabled = false;
            closeConfirmModal();
        });
    }
    </script>


<script>
    let modalAction = null;
    
    function openModal(title, message, confirmCallback) {
        document.getElementById("modalTitle").innerText = title;
        document.getElementById("modalMessage").innerText = message;
        
        modalAction = confirmCallback;
    
        document.getElementById("confirmModal").classList.remove("hidden");
    }
    
    document.getElementById("modalCancel").addEventListener("click", () => {
        document.getElementById("confirmModal").classList.add("hidden");
        modalAction = null;
    });
    
    document.getElementById("modalConfirm").addEventListener("click", () => {
        if (modalAction) modalAction();   // execute the callback
        document.getElementById("confirmModal").classList.add("hidden");
    });
    </script>
    
    

</body>
</html>