{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="container mx-auto px-4 py-8">

  <!-- Breadcrumb -->
  <nav class="text-sm text-gray-600 mb-8 flex items-center gap-2">
    <a href="{% url 'home' %}" class="hover:text-blue-600 transition-colors flex items-center gap-1">
      <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
        <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
      </svg>
      Home
    </a>
    <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
      <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
    </svg>
    {% if product.category %}
    <!-- ?category={{ product.category.slug }} -->
      <a href="{% url 'user_product_list' %}" 
         class="hover:text-blue-600 transition-colors"> All Products</a>
      <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
        <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
      </svg>
    {% endif %}
    <span class="text-gray-900 font-medium">{{ product.product_name }}</span>
  </nav>

  <!-- Main Product Section -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 mb-16">

    <!-- LEFT: IMAGES WITH ZOOM -->
    <div class="space-y-4">
      
      <!-- Main Image Display with Zoom -->
      <div class="relative bg-gray-50 rounded-2xl overflow-hidden shadow-lg aspect-square" id="imageZoomContainer">
        {% if variant_images %}
          <img id="mainImage" 
               src="{{ variant_images.0.image.url }}" 
               class="w-full h-full object-contain p-8 cursor-zoom-in" 
               alt="{{ product.product_name }}"
               onmousemove="zoomImage(event)"
               onmouseleave="resetZoom()">
        {% else %}
          <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-200 to-gray-300">
            <svg class="w-32 h-32 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
          </div>
        {% endif %}
        
        <!-- Badges -->
        <div class="absolute top-4 left-4 flex flex-col gap-2">
          {% if product.offer %}
            <span class="bg-red-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">
              {{ product.offer.discount_percentage }}% OFF
            </span>
          {% endif %}
          {% if selected_variant.stock > 0 and selected_variant.stock <= 5 %}
            <span class="bg-orange-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">
              Only {{ selected_variant.stock }} Left!
            </span>
          {% elif selected_variant.stock > 5 and selected_variant.stock <= 10 %}
            <span class="bg-yellow-600 text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg">
              {{ selected_variant.stock }} in Stock
            </span>
          {% endif %}
        </div>

        <!-- Wishlist Button -->
        <button class="absolute top-4 right-4 w-12 h-12 bg-white rounded-full flex items-center justify-center text-gray-400 hover:text-red-500 hover:scale-110 transition-all shadow-lg">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
          </svg>
        </button>

        <!-- Zoom Hint -->
        <div class="absolute bottom-4 right-4 bg-black/70 text-white text-xs px-3 py-2 rounded-lg backdrop-blur-sm">
          <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path>
          </svg>
          Hover to zoom
        </div>
      </div>

      <!-- Thumbnail Gallery -->
      <div class="grid grid-cols-5 gap-3">
        {% for img in variant_images %}
          <button onclick="changeMainImage('{{ img.image.url }}')" 
                  class="aspect-square rounded-lg overflow-hidden border-2 {% if forloop.first %}border-blue-600{% else %}border-gray-200{% endif %} hover:border-blue-600 transition-all focus:outline-none bg-gray-50 thumbnail-btn">
            <img src="{{ img.image.url }}" 
                 class="w-full h-full object-contain p-2" 
                 alt="Product view {{ forloop.counter }}">
          </button>
        {% empty %}
          <p class="col-span-5 text-center text-gray-500 text-sm py-4">No additional images available</p>
        {% endfor %}
      </div>

    </div>

    <!-- RIGHT: PRODUCT DETAILS -->
    <div class="space-y-6">
      
      <!-- Product Title & Category -->
      <div>
        {% if product.category %}
          <p class="text-sm text-blue-600 font-medium mb-2 uppercase tracking-wide">{{ product.category.category_name }}</p>
        {% endif %}
        <h1 class="text-4xl font-bold text-gray-900 mb-3">{{ product.product_name }}</h1>
        
        <!-- Rating & Reviews -->
        <div class="flex items-center gap-4 mb-4">
          <div class="flex items-center gap-1">
            <div class="flex text-yellow-400">
              {% for i in "12345" %}
                <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20">
                  <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                </svg>
              {% endfor %}
            </div>
            <span class="text-sm font-semibold text-gray-900 ml-1">4.8</span>
          </div>
          <span class="text-sm text-gray-600">(128 reviews)</span>
          <button class="text-sm text-blue-600 hover:text-blue-700 font-medium">Write a review</button>
        </div>
      </div>

      <!-- Price & Discount -->
      <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-xl p-6 border border-blue-100">
        <div class="flex items-baseline gap-3 mb-2">
          <span class="text-4xl font-bold text-gray-900">â‚¹{{ selected_variant.price }}</span>
          {% if product.offer %}
            <span class="text-xl text-gray-500 line-through">â‚¹{{ product.base_price }}</span>
            <span class="bg-green-500 text-white px-3 py-1 rounded-full text-sm font-bold">
              {{ product.offer.discount_percentage }}% OFF
            </span>
          {% endif %}
        </div>
        <p class="text-sm text-gray-600">Inclusive of all taxes</p>
        {% if product.offer %}
          <p class="text-sm text-green-700 font-medium mt-2">
            ðŸŽ‰ You save â‚¹{{ product.base_price|add:"-"|add:selected_variant.price }}!
          </p>
        {% endif %}
      </div>

      <!-- Stock Status -->
      <div class="flex items-center gap-2 p-4 rounded-lg {% if selected_variant.stock > 0 %}bg-green-50 border border-green-200{% else %}bg-red-50 border border-red-200{% endif %}" data-stock="{{ selected_variant.stock }}">
        {% if selected_variant.stock > 0 %}
          <svg class="w-6 h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <div>
            <p class="text-green-800 font-bold text-sm">âœ“ In Stock</p>
            <p class="text-green-600 text-xs">{{ selected_variant.stock }} unit{{ selected_variant.stock|pluralize }} available</p>
          </div>
        {% else %}
          <svg class="w-6 h-6 text-red-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <div>
            <p class="text-red-800 font-bold text-sm">âœ— Out of Stock</p>
            <p class="text-red-600 text-xs">This variant is currently unavailable</p>
          </div>
        {% endif %}
      </div>

      <!-- Color Selection -->
      <div>
        <h3 class="text-sm font-bold text-gray-900 mb-3 flex items-center">
          <svg class="w-5 h-5 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"></path>
          </svg>
          Select Color: <span class="text-blue-600 ml-2">{{ selected_variant.colour }}</span>
        </h3>
        
        <div class="flex flex-wrap gap-3">
          {% for v in variants %}
            <a href="?variant={{ v.id }}" 
               class="group relative px-6 py-3 rounded-lg border-2 transition-all
                      {% if v.id == selected_variant.id %}
                        border-blue-600 bg-blue-50
                      {% else %}
                        border-gray-300 hover:border-blue-400 bg-white
                      {% endif %}
                      {% if v.stock == 0 %}opacity-50 cursor-not-allowed{% endif %}">
              <span class="font-medium
                           {% if v.id == selected_variant.id %}
                             text-blue-700
                           {% else %}
                             text-gray-700 group-hover:text-blue-600
                           {% endif %}">
                {{ v.colour }}
              </span>
              
              {% if v.stock == 0 %}
                <span class="absolute -top-2 -right-2 bg-red-600 text-white text-xs px-2 py-0.5 rounded-full">
                  Sold Out
                </span>
              {% endif %}
              
              {% if v.id == selected_variant.id %}
                <svg class="absolute -top-1 -right-1 w-5 h-5 text-blue-600 bg-white rounded-full" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
              {% endif %}
            </a>
          {% empty %}
            <p class="text-gray-500 text-sm">No color options available</p>
          {% endfor %}
        </div>
      </div>

      <!-- Add to Cart & Buy Now Buttons -->
      <div class="space-y-3">
        {% if selected_variant.stock > 0 %}
          <button onclick="checkProductAvailability('add_to_cart')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-4 rounded-xl transition-all shadow-md hover:shadow-lg flex items-center justify-center gap-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            Add to Cart
          </button>
          
          <button onclick="checkProductAvailability('buy_now')" class="w-full bg-gray-900 hover:bg-gray-800 text-white font-semibold py-4 rounded-xl transition-all shadow-md hover:shadow-lg">
            Buy Now
          </button>
        {% else %}
          <button disabled class="w-full bg-gray-300 text-gray-500 font-semibold py-4 rounded-xl cursor-not-allowed flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M13.477 14.89A6 6 0 015.11 6.524l8.367 8.368zm1.414-1.414L6.524 5.11a6 6 0 018.367 8.367zM18 10a8 8 0 11-16 0 8 8 0 0116 0z" clip-rule="evenodd"/>
            </svg>
            Out of Stock - Notify Me
          </button>
        {% endif %}
      </div>

      <!-- Product Highlights -->
      <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
        <h3 class="font-bold text-gray-900 mb-4 flex items-center">
          <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
          </svg>
          Product Highlights
        </h3>
        <ul class="space-y-3">
          <li class="flex items-start gap-3">
            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="text-sm text-gray-700">Premium quality materials</span>
          </li>
          <li class="flex items-start gap-3">
            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="text-sm text-gray-700">100% Authentic & Original</span>
          </li>
          <li class="flex items-start gap-3">
            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="text-sm text-gray-700">Easy returns within 30 days</span>
          </li>
          <li class="flex items-start gap-3">
            <svg class="w-5 h-5 text-green-600 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            </svg>
            <span class="text-sm text-gray-700">Free shipping on orders above â‚¹999</span>
          </li>
        </ul>
      </div>

      <!-- Additional Services -->
      <div class="grid grid-cols-3 gap-4">
        <div class="text-center p-4 bg-white rounded-lg border border-gray-200">
          <svg class="w-8 h-8 mx-auto mb-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path>
          </svg>
          <p class="text-xs font-medium text-gray-700">Free Shipping</p>
        </div>
        <div class="text-center p-4 bg-white rounded-lg border border-gray-200">
          <svg class="w-8 h-8 mx-auto mb-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          <p class="text-xs font-medium text-gray-700">Secure Payment</p>
        </div>
        <div class="text-center p-4 bg-white rounded-lg border border-gray-200">
          <svg class="w-8 h-8 mx-auto mb-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          <p class="text-xs font-medium text-gray-700">Easy Returns</p>
        </div>
      </div>

    </div>
  </div>

  <!-- Tabs: Description & Reviews -->
  <div class="bg-white rounded-2xl shadow-md border border-gray-100 mb-16">
    <div class="border-b border-gray-200">
      <nav class="flex">
        <button onclick="showTab('description')" id="descTab" class="tab-button px-8 py-4 font-semibold text-blue-600 border-b-2 border-blue-600">
          Description
        </button>
        <button onclick="showTab('reviews')" id="reviewTab" class="tab-button px-8 py-4 font-semibold text-gray-600 border-b-2 border-transparent hover:text-gray-900">
          Reviews (128)
        </button>
        <button onclick="showTab('specs')" id="specsTab" class="tab-button px-8 py-4 font-semibold text-gray-600 border-b-2 border-transparent hover:text-gray-900">
          Specifications
        </button>
      </nav>
    </div>

    <!-- Description Tab -->
    <div id="descriptionContent" class="tab-content p-8">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Product Description</h3>
      <div class="prose max-w-none text-gray-700 leading-relaxed">
        {{ product.description|linebreaks }}
      </div>
    </div>

    <!-- Reviews Tab -->
    <div id="reviewsContent" class="tab-content p-8 hidden">
      <h3 class="text-xl font-bold text-gray-900 mb-6">Customer Reviews</h3>
      
      <!-- Overall Rating -->
      <div class="flex items-center gap-8 mb-8 p-6 bg-gray-50 rounded-xl">
        <div class="text-center">
          <div class="text-5xl font-bold text-gray-900 mb-2">4.8</div>
          <div class="flex text-yellow-400 mb-2">
            {% for i in "12345" %}
              <svg class="w-5 h-5 fill-current" viewBox="0 0 20 20">
                <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
              </svg>
            {% endfor %}
          </div>
          <p class="text-sm text-gray-600">Based on 128 reviews</p>
        </div>
        
        <div class="flex-1">
          {% for star in "54321" %}
          <div class="flex items-center gap-2 mb-2">
            <span class="text-sm text-gray-600 w-12">{{ star }} star</span>
            <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
              <div class="h-full bg-yellow-400" style="width: {% if star == '5' %}70{% elif star == '4' %}20{% elif star == '3' %}5{% elif star == '2' %}3{% else %}2{% endif %}%"></div>
            </div>
            <span class="text-sm text-gray-600 w-12">{% if star == '5' %}90{% elif star == '4' %}26{% elif star == '3' %}6{% elif star == '2' %}4{% else %}2{% endif %}</span>
          </div>
          {% endfor %}
        </div>
      </div>

      <!-- Individual Reviews -->
      <div class="space-y-6">
        {% for i in "123" %}
        <div class="border-b border-gray-200 pb-6">
          <div class="flex items-start gap-4">
            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-bold">
              {{ "ABC"|slice:forloop.counter0|first }}
            </div>
            <div class="flex-1">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-semibold text-gray-900">Customer {{ i }}</h4>
                <span class="text-sm text-gray-500">2 days ago</span>
              </div>
              <div class="flex text-yellow-400 mb-2">
                {% for j in "12345" %}
                  <svg class="w-4 h-4 fill-current" viewBox="0 0 20 20">
                    <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                  </svg>
                {% endfor %}
              </div>
              <p class="text-gray-700 text-sm leading-relaxed">
                Great product! Excellent quality and fits perfectly. Highly recommend to anyone looking for this style.
              </p>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <button class="mt-6 text-blue-600 hover:text-blue-700 font-semibold text-sm">
        Load More Reviews â†’
      </button>
    </div>

    <!-- Specifications Tab -->
    <div id="specsContent" class="tab-content p-8 hidden">
      <h3 class="text-xl font-bold text-gray-900 mb-6">Product Specifications</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="flex py-3 border-b border-gray-200">
          <span class="font-semibold text-gray-700 w-1/2">Category</span>
          <span class="text-gray-600 w-1/2">{{ product.category.category_name }}</span>
        </div>
        <div class="flex py-3 border-b border-gray-200">
          <span class="font-semibold text-gray-700 w-1/2">Color</span>
          <span class="text-gray-600 w-1/2">{{ selected_variant.colour }}</span>
        </div>
        <div class="flex py-3 border-b border-gray-200">
          <span class="font-semibold text-gray-700 w-1/2">Availability</span>
          <span class="text-gray-600 w-1/2">
            {% if selected_variant.stock > 0 %}
              <span class="text-green-600 font-semibold">In Stock ({{ selected_variant.stock }} units)</span>
            {% else %}
              <span class="text-red-600 font-semibold">Out of Stock</span>
            {% endif %}
          </span>
        </div>
        <div class="flex py-3 border-b border-gray-200">
          <span class="font-semibold text-gray-700 w-1/2">Product Code</span>
          <span class="text-gray-600 w-1/2">{{ product.slug|upper }}-{{ selected_variant.id }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Related Products -->
  {% if related %}
  <div class="mb-16">
    <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">You May Also Like</h2>
    
    <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
      {% for item in related %}
      <a href="{% url 'product_detail' item.slug %}" 
         class="group bg-white rounded-xl shadow-sm hover:shadow-xl transition-all duration-300 overflow-hidden border border-gray-100">
        
        <div class="relative overflow-hidden bg-gray-50 aspect-square">
          {% with variant=item.varients.first %}
            {% if variant %}
              {% with img=variant.images.first %}
                {% if img %}
                  <img src="{{ img.image.url }}" 
                       class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" 
                       alt="{{ item.product_name }}">
                {% else %}
                  <div class="w-full h-full bg-gradient-to-br from-gray-200 to-gray-300"></div>
                {% endif %}
              {% endwith %}
            {% endif %}
          {% endwith %}
          
          <!-- Wishlist -->
          <button class="absolute top-2 right-2 w-8 h-8 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
            <svg class="w-4 h-4 text-gray-600 hover:text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
            </svg>
          </button>
        </div>
        
        <div class="p-4">
          <h3 class="font-semibold text-gray-900 text-sm mb-2 line-clamp-2 group-hover:text-blue-600 transition-colors">
            {{ item.product_name }}
          </h3>
          
          <div class="flex items-center justify-between">
            {% if item.min_price %}
              <p class="text-blue-700 font-bold">â‚¹{{ item.min_price }}</p>
            {% else %}
              {% with variant=item.varients.first %}
                {% if variant %}
                  <p class="text-blue-700 font-bold">â‚¹{{ variant.price }}</p>
                {% endif %}
              {% endwith %}
            {% endif %}
            
            <div class="flex text-yellow-400">
              {% for i in "12345" %}
                <svg class="w-3 h-3 fill-current" viewBox="0 0 20 20">
                  <path d="M10 15l-5.878 3.09 1.123-6.545L.489 6.91l6.572-.955L10 0l2.939 5.955 6.572.955-4.756 4.635 1.123 6.545z"/>
                </svg>
              {% endfor %}
            </div>
          </div>
        </div>
      </a>
      {% endfor %}
    </div>

    <div class="text-center mt-8">
      <a href="{% url 'user_product_list' %}" class="inline-block bg-gray-900 text-white px-8 py-3 rounded-lg font-semibold hover:bg-gray-800 transition-all">
        View All Products
      </a>
    </div>
  </div>
  {% endif %}

</div>

<script>
// Image Zoom Functionality
function zoomImage(event) {
  const img = event.target;
  const container = document.getElementById('imageZoomContainer');
  const rect = container.getBoundingClientRect();
  const x = ((event.clientX - rect.left) / rect.width) * 100;
  const y = ((event.clientY - rect.top) / rect.height) * 100;
  
  img.style.transformOrigin = `${x}% ${y}%`;
  img.style.transform = 'scale(2)';
  img.style.cursor = 'zoom-out';
}

function resetZoom() {
  const img = document.getElementById('mainImage');
  img.style.transform = 'scale(1)';
  img.style.cursor = 'zoom-in';
}

// Change Main Image
function changeMainImage(imageUrl) {
  document.getElementById('mainImage').src = imageUrl;
  
  // Update thumbnail active state
  const thumbnails = document.querySelectorAll('.thumbnail-btn');
  thumbnails.forEach(btn => {
    btn.classList.remove('border-blue-600');
    btn.classList.add('border-gray-200');
  });
  event.target.closest('.thumbnail-btn').classList.remove('border-gray-200');
  event.target.closest('.thumbnail-btn').classList.add('border-blue-600');
}

// Tab Functionality
function showTab(tabName) {
  // Hide all tabs
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.add('hidden');
  });
  
  // Remove active state from all buttons
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('text-blue-600', 'border-blue-600');
    btn.classList.add('text-gray-600', 'border-transparent');
  });
  
  // Show selected tab
  document.getElementById(tabName + 'Content').classList.remove('hidden');
  
  // Add active state to clicked button
  const activeBtn = document.getElementById(tabName.substring(0, tabName.length - 10) + 'Tab');
  if (activeBtn) {
    activeBtn.classList.remove('text-gray-600', 'border-transparent');
    activeBtn.classList.add('text-blue-600', 'border-blue-600');
  } else {
    // For description which is default
    document.getElementById('descTab').classList.remove('text-gray-600', 'border-transparent');
    document.getElementById('descTab').classList.add('text-blue-600', 'border-blue-600');
  }
}

// Check Product Availability (AJAX)
function checkProductAvailability(action) {
  const stockElement = document.querySelector('[data-stock]');
  const currentStock = parseInt(stockElement.dataset.stock);
  
  // Check stock immediately without AJAX first
  if (currentStock <= 0) {
    alert('Sorry, this product is currently out of stock!');
    return;
  }
  
  // Product is available, proceed with action
  if (action === 'add_to_cart') {
    addToCart();
  } else if (action === 'buy_now') {
    buyNow();
  }
}

// Add to Cart (Placeholder)
function addToCart() {
  const stockElement = document.querySelector('[data-stock]');
  const currentStock = parseInt(stockElement.dataset.stock);
  
  if (currentStock > 0) {
    // TODO: Implement actual add to cart functionality
    showToast('Product added to cart successfully!', 'success');
    console.log('Adding to cart - Stock available:', currentStock);
  } else {
    showToast('Sorry, this product is out of stock!', 'error');
  }
}

// Buy Now (Placeholder)
function buyNow() {
  const stockElement = document.querySelector('[data-stock]');
  const currentStock = parseInt(stockElement.dataset.stock);
  
  if (currentStock > 0) {
    // TODO: Implement actual buy now functionality
    showToast('Proceeding to checkout!', 'success');
    console.log('Buy now - Stock available:', currentStock);
  } else {
    showToast('Sorry, this product is out of stock!', 'error');
  }
}

// Auto-refresh check for product availability (Optional - can be enabled)
// This checks if the product becomes unavailable while user is viewing
let autoCheckEnabled = false; // Set to true to enable background checks

if (autoCheckEnabled) {
  let lastCheckTime = Date.now();
  setInterval(() => {
    const currentTime = Date.now();
    // Check every 60 seconds if user is active
    if (currentTime - lastCheckTime > 60000) {
      fetch(window.location.href, {
        method: 'GET',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        }
      })
      .then(response => {
        if (response.redirected) {
          // Product became unavailable
          alert('This product is no longer available.');
          window.location.href = "{% url 'user_product_list' %}";
        }
      })
      .catch(error => console.error('Availability check error:', error));
      
      lastCheckTime = currentTime;
    }
  }, 10000); // Check every 10 seconds

  // Update last check time on user interaction
  document.addEventListener('click', () => {
    lastCheckTime = Date.now();
  });
  document.addEventListener('scroll', () => {
    lastCheckTime = Date.now();
  });
}
</script>

<style>
.line-clamp-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

#mainImage {
  transition: transform 0.3s ease;
}

.thumbnail-btn {
  transition: all 0.2s ease;
}

.thumbnail-btn:hover {
  transform: scale(1.05);
}
</style>

{% endblock %}