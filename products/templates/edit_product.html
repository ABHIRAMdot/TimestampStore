{% extends 'admin_base.html' %}
{% block title %}Edit Product{% endblock %}
{% block page_title %}Edit Product{% endblock %}

{% block content %}

<!-- Header -->
<div class="flex justify-between items-center mb-8">
  <div>
    <h1 class="text-2xl font-bold text-gray-800">Edit Product</h1>
    <p class="text-gray-600 mt-1">Update product information, variants and images</p>
  </div>
  <a href="{% url 'product_list' %}" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">
    <i class="fas fa-arrow-left mr-2"></i>Back to List
  </a>
</div>

<!-- Product info pill -->
<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 flex items-center justify-between">
  <div>
    <p class="text-sm text-blue-800">Editing Product ID: <span class="font-semibold">#{{ product.id }}</span></p>
    <p class="text-xs text-blue-600 mt-1">Created: {{ product.created_at|date:"M d, Y H:i" }}</p>
  </div>
  <div>
    {% if product.is_listed %}
      <span class="px-3 py-1 bg-green-100 text-green-800 text-xs rounded-full font-medium">
        <i class="fas fa-check-circle"></i> Active
      </span>
    {% else %}
      <span class="px-3 py-1 bg-red-100 text-red-800 text-xs rounded-full font-medium">
        <i class="fas fa-times-circle"></i> Inactive
      </span>
    {% endif %}
  </div>
</div>

<form id="productForm" method="POST" enctype="multipart/form-data" class="space-y-6">
  {% csrf_token %}

  <!-- Basic Information -->
  <div class="bg-white rounded-xl shadow-sm p-6">
    <h2 class="text-lg font-semibold mb-4">Basic Information</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-2">Product Name <span class="text-red-500">*</span></label>
        <input type="text" name="product_name" value="{{ product.product_name }}" required
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
               placeholder="Enter product name">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Category <span class="text-red-500">*</span></label>
        <select name="category" required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="">Select Category</option>
          {% for cat in categories %}
            <option value="{{ cat.id }}" {% if product.category.id == cat.id %}selected{% endif %}>
              {{ cat.parent.category_name }} â†’ {{ cat.category_name }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Offer (Optional)</label>
        <select name="offer" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
          <option value="">No Offer</option>
          {% for offer in offers %}
            <option value="{{ offer.id }}" {% if product.offer and product.offer.id == offer.id %}selected{% endif %}>
              {{ offer.name }} ({{ offer.discount }}% off)
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Base Price <span class="text-red-500">*</span></label>
        <input type="number" name="base_price" value="{{ product.base_price }}" step="0.01" min="0" required
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
               placeholder="0.00">
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-2">Slug <span class="text-red-500">*</span></label>
        <input type="text" name="slug" value="{{ product.slug }}" required
               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
        <p class="text-xs text-gray-500 mt-1">URL-friendly version of the name</p>
      </div>

      <div class="md:col-span-2">
        <label class="block text-sm font-medium text-gray-700 mb-2">Description <span class="text-red-500">*</span></label>
        <textarea name="description" rows="4" required
                  class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">{{ product.description }}</textarea>
      </div>
    </div>
  </div>

  <!-- Existing Product Images -->
  <div class="bg-white rounded-xl shadow-sm p-6">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Product Images</h2>
      <span class="text-xs text-gray-500">Minimum 3 images required</span>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="existingImagesGrid">
      {% for image in product.images.all %}
      <div class="relative group border rounded-lg overflow-hidden" data-image-id="{{ image.id }}">
        <img src="{{ image.image_url.url }}" alt="Product Image" class="w-full h-48 object-cover">
        
        <div class="absolute inset-0 flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 transition bg-black/40">
          <button type="button" class="px-2 py-1 bg-white text-sm rounded hover:bg-gray-100" 
                  onclick="editExistingImage({{ image.id }}, '{{ image.image_url.url }}')">Crop</button>
          <button type="button" class="px-2 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700" 
                  onclick="confirmDeleteImage({{ image.id }}, '{{ product.product_name }}')">Delete</button>
        </div>

        <input type="checkbox" name="delete_images" value="{{ image.id }}" class="hidden" id="del-{{ image.id }}">

        <label class="absolute bottom-2 right-2 cursor-pointer flex items-center bg-white rounded px-2 py-1 shadow">
          <input type="radio" name="primary_image" value="{{ image.id }}" 
                 {% if image.is_primary %}checked{% endif %} class="h-4 w-4 text-blue-600">
          <span class="ml-1 text-xs">Primary</span>
        </label>

        {% if image.is_primary %}
          <span class="absolute top-2 left-2 bg-blue-600 text-white text-xs px-2 py-1 rounded">Primary</span>
        {% endif %}
      </div>
      {% endfor %}
    </div>

    <div class="border-t pt-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-semibold">Add New Images</h3>
        <label class="inline-block px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 cursor-pointer transition">
          <i class="fas fa-plus mr-2"></i>Select Images
          <input type="file" id="newImageInput" accept="image/*" multiple class="hidden">
        </label>
      </div>

      <div id="newImagesGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>

      <p id="imageCount" class="mt-3 text-sm text-gray-600">
        Current: {{ product.images.count }} images | Minimum 3 required
      </p>
    </div>
  </div>

  <!-- Product Variants -->
  <div class="bg-white rounded-xl shadow-sm p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold">Product Variants</h2>
      <button type="button" onclick="addVariant()" 
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
        <i class="fas fa-plus mr-2"></i>Add Variant
      </button>
    </div>

    <div id="variantsContainer" class="space-y-4">
      {% for variant in product.varients.all %}
      <div class="border border-gray-200 rounded-lg p-4">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-medium text-gray-700">Variant: {{ variant.colour }}</h3>
          <button type="button" 
                  onclick="confirmDeleteVariant({{ variant.id }}, '{{ variant.colour }}', '{{ product.product_name }}')"
                  class="text-red-600 hover:text-red-800 transition">
            <i class="fas fa-trash mr-1"></i>Delete
          </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <input type="hidden" name="variant_id[]" value="{{ variant.id }}">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Color <span class="text-red-500">*</span></label>
            <select name="colour[]" required class="w-full px-4 py-2 border rounded-lg">
              <option value="">Select Color</option>
              <option value="Black" {% if variant.colour == 'Black' %}selected{% endif %}>Black</option>
              <option value="Blue" {% if variant.colour == 'Blue' %}selected{% endif %}>Blue</option>
              <option value="Brown" {% if variant.colour == 'Brown' %}selected{% endif %}>Brown</option>
              <option value="White" {% if variant.colour == 'White' %}selected{% endif %}>White</option>
              <option value="Red" {% if variant.colour == 'Red' %}selected{% endif %}>Red</option>
              <option value="Green" {% if variant.colour == 'Green' %}selected{% endif %}>Green</option>
              <option value="Yellow" {% if variant.colour == 'Yellow' %}selected{% endif %}>Yellow</option>
              <option value="Gray" {% if variant.colour == 'Gray' %}selected{% endif %}>Gray</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Price <span class="text-red-500">*</span></label>
            <input type="number" name="price[]" value="{{ variant.price }}" step="0.01" min="0" required
                   class="w-full px-4 py-2 border rounded-lg">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">Stock <span class="text-red-500">*</span></label>
            <input type="number" name="stock[]" value="{{ variant.stock }}" min="0" required
                   class="w-full px-4 py-2 border rounded-lg">
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <p class="text-sm text-gray-500 mt-4">At least one variant is required</p>
  </div>

  <!-- Submit -->
  <div class="flex justify-end gap-4">
    <a href="{% url 'product_list' %}" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition">Cancel</a>
    <button type="submit" id="submitBtn" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
      <i class="fas fa-save mr-2"></i>Update Product
    </button>
  </div>
</form>

<!-- Delete Image Modal -->
<div id="deleteImageModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-red-100 mb-4">
      <i class="fas fa-trash text-red-600 text-xl"></i>
    </div>
    <h3 class="text-lg font-semibold text-gray-900 mb-2">Delete Image</h3>
    <p class="text-gray-600 mb-6" id="deleteImageMessage"></p>
    <div class="flex gap-3">
      <button onclick="closeDeleteImageModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
        Cancel
      </button>
      <button onclick="executeImageDelete()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
        Delete
      </button>
    </div>
  </div>
</div>

<!-- Delete Variant Modal -->
<div id="deleteVariantModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
    <div class="flex items-center justify-center w-12 h-12 rounded-full bg-red-100 mb-4">
      <i class="fas fa-trash text-red-600 text-xl"></i>
    </div>
    <h3 class="text-lg font-semibold text-gray-900 mb-2">Delete Variant</h3>
    <p class="text-gray-600 mb-6" id="deleteVariantMessage"></p>
    <div class="flex gap-3">
      <button onclick="closeDeleteVariantModal()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
        Cancel
      </button>
      <button onclick="executeVariantDelete()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
        Delete
      </button>
    </div>
  </div>
</div>

<!-- Cropper Modal -->
<div id="cropperModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
    <div class="p-4 border-b flex justify-between items-center">
      <h3 class="text-lg font-semibold">Crop Image</h3>
      <button type="button" onclick="closeCropper()" class="text-gray-400 hover:text-gray-600">
        <i class="fas fa-times text-xl"></i>
      </button>
    </div>
    <div class="p-4 overflow-auto" style="max-height: calc(90vh - 160px);">
      <div class="flex justify-center">
        <img id="cropperImage" class="max-w-full" style="max-height: 65vh;">
      </div>
    </div>
    <div class="p-4 border-t flex justify-between">
      <button type="button" onclick="resetCropper()" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg">
        <i class="fas fa-undo"></i> Reset
      </button>
      <div class="flex gap-2">
        <button type="button" onclick="closeCropper()" class="px-4 py-2 bg-gray-300 text-gray-700 hover:bg-gray-400 rounded-lg">Cancel</button>
        <button type="button" onclick="confirmCrop()" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg">
          <i class="fas fa-check mr-1"></i>Crop & Use
        </button>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
let cropper = null;
let cropContext = null;
let newFiles = [];
let deleteImageId = null;
let deleteVariantId = null;

const existingGrid = document.getElementById('existingImagesGrid');
const newGrid = document.getElementById('newImagesGrid');
const countDisplay = document.getElementById('imageCount');
const newInput = document.getElementById('newImageInput');

// Image deletion
function confirmDeleteImage(id, productName) {
  deleteImageId = id;
  document.getElementById('deleteImageMessage').textContent = 
    `Are you sure you want to delete this image from "${productName}"?`;
  document.getElementById('deleteImageModal').classList.remove('hidden');
}

function executeImageDelete() {
  const cb = document.getElementById('del-' + deleteImageId);
  if (cb) cb.checked = true;
  const card = existingGrid.querySelector(`[data-image-id="${deleteImageId}"]`);
  if (card) card.classList.add('opacity-30', 'pointer-events-none');
  closeDeleteImageModal();
  updateImageCount();
}

function closeDeleteImageModal() {
  document.getElementById('deleteImageModal').classList.add('hidden');
  deleteImageId = null;
}

// Variant deletion
function confirmDeleteVariant(id, colour, productName) {
  deleteVariantId = id;
  document.getElementById('deleteVariantMessage').textContent = 
    `Are you sure you want to delete the "${colour}" variant from "${productName}"?`;
  document.getElementById('deleteVariantModal').classList.remove('hidden');
}

function executeVariantDelete() {
  const input = document.createElement('input');
  input.type = 'hidden';
  input.name = 'delete_variants';
  input.value = deleteVariantId;
  
  const container = document.getElementById('variantsContainer');
  const variants = container.querySelectorAll('.border');
  
  variants.forEach(v => {
    const hiddenInput = v.querySelector('input[name="variant_id[]"]');
    if (hiddenInput && hiddenInput.value == deleteVariantId) {
      v.style.opacity = '0.3';
      v.style.pointerEvents = 'none';
      v.appendChild(input);
    }
  });
  
  closeDeleteVariantModal();
}

function closeDeleteVariantModal() {
  document.getElementById('deleteVariantModal').classList.add('hidden');
  deleteVariantId = null;
}

// New images
newInput.addEventListener('change', (e) => {
  const files = Array.from(e.target.files || []);
  files.forEach((file) => {
    const preview = URL.createObjectURL(file);
    newFiles.push({ file, preview });
  });
  renderNewGrid();
  updateImageCount();
  newInput.value = '';
});

function renderNewGrid() {
  newGrid.innerHTML = '';
  newFiles.forEach((nf, idx) => {
    const div = document.createElement('div');
    div.className = 'relative group border rounded-lg overflow-hidden';
    div.innerHTML = `
      <img src="${nf.preview}" class="w-full h-48 object-cover">
      <div class="absolute inset-0 flex items-center justify-center gap-2 opacity-0 group-hover:opacity-100 bg-black/40">
        <button type="button" class="px-2 py-1 bg-white text-sm rounded" onclick="editNewImage(${idx})">Crop</button>
        <button type="button" class="px-2 py-1 bg-red-600 text-white text-sm rounded" onclick="deleteNewImage(${idx})">Delete</button>
      </div>
      ${nf.replaceOf ? `<span class="absolute top-2 left-2 bg-green-600 text-white text-xs px-2 py-1 rounded">Replaces #${nf.replaceOf}</span>` : ''}
    `;
    newGrid.appendChild(div);
  });
}

function editExistingImage(id, url) {
  cropContext = { mode: 'existing', imageId: id, src: url };
  openCropper(url);
}

function editNewImage(index) {
  const src = newFiles[index].preview;
  cropContext = { mode: 'new', newIndex: index, src };
  openCropper(src);
}

function deleteNewImage(index) {
  URL.revokeObjectURL(newFiles[index].preview);
  newFiles.splice(index, 1);
  renderNewGrid();
  updateImageCount();
}

function openCropper(src) {
  const img = document.getElementById('cropperImage');
  img.src = src;
  document.getElementById('cropperModal').classList.remove('hidden');

  setTimeout(() => {
    if (cropper) cropper.destroy();
    cropper = new Cropper(img, {
      viewMode: 1,
      dragMode: 'crop',
      background: false,
      zoomOnWheel: true,
      autoCrop: true,
      autoCropArea: 0.8,
      responsive: true
    });
  }, 50);
}

function resetCropper() {
  if (cropper) cropper.reset();
}

function closeCropper() {
  document.getElementById('cropperModal').classList.add('hidden');
  if (cropper) { cropper.destroy(); cropper = null; }
  cropContext = null;
}

function confirmCrop() {
  if (!cropper || !cropContext) return;

  cropper.getCroppedCanvas({
    imageSmoothingEnabled: true,
    imageSmoothingQuality: 'high'
  }).toBlob((blob) => {
    const newFile = new File([blob], `cropped_${Date.now()}.jpg`, { type: 'image/jpeg' });
    const preview = URL.createObjectURL(newFile);

    if (cropContext.mode === 'existing') {
      const id = cropContext.imageId;
      const cb = document.getElementById('del-' + id);
      if (cb) cb.checked = true;

      newFiles.push({ file: newFile, preview, replaceOf: id });

      const card = existingGrid.querySelector(`[data-image-id="${id}"]`);
      if (card) card.classList.add('opacity-60');

      renderNewGrid();
      updateImageCount();

    } else if (cropContext.mode === 'new') {
      const i = cropContext.newIndex;
      URL.revokeObjectURL(newFiles[i].preview);
      newFiles[i] = { ...newFiles[i], file: newFile, preview };
      renderNewGrid();
    }

    closeCropper();
  }, 'image/jpeg', 0.9);
}

function updateImageCount() {
  const existingCount = {{ product.images.count }};
  const toDelete = document.querySelectorAll('input[name="delete_images"]:checked').length;
  const newCount = newFiles.length;
  const finalCount = existingCount - toDelete + newCount;

  countDisplay.textContent = `Current: ${existingCount} | Adding: ${newCount} | Deleting: ${toDelete} | Final: ${finalCount}`;
  countDisplay.className = 'mt-3 text-sm ' + (finalCount < 3 ? 'text-red-600' : 'text-green-600');
}

// Form submit
document.getElementById('productForm').addEventListener('submit', (e) => {
  e.preventDefault();
  const formData = new FormData(e.target);

  newFiles.forEach((nf) => {
    formData.append('images', nf.file, nf.file.name);
  });

  fetch(e.target.action, {
    method: 'POST',
    body: formData,
    headers: { 'X-Requested-With': 'XMLHttpRequest' }
  }).then(r => {
    if (r.redirected) { window.location.href = r.url; return null; }
    return r.text();
  }).then(html => {
    if (html) {
      document.open(); document.write(html); document.close();
    }
  }).catch(() => alert('An error occurred while updating the product.'));
});

// Add variant
let variantCount = 0;
function addVariant() {
  variantCount++;
  const container = document.getElementById('variantsContainer');
  const div = document.createElement('div');
  div.className = 'border border-green-300 rounded-lg p-4 bg-green-50';
  div.innerHTML = `
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-medium text-gray-700">New Variant #${variantCount}</h3>
      <button type="button" onclick="this.closest('div.border').remove()" class="text-red-600 hover:text-red-800">
        <i class="fas fa-trash"></i>
      </button>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Color <span class="text-red-500">*</span></label>
        <select name="colour[]" required class="w-full px-4 py-2 border rounded-lg">
          <option value="">Select Color</option>
          <option value="Black">Black</option>
          <option value="Blue">Blue</option>
          <option value="Brown">Brown</option>
          <option value="White">White</option>
          <option value="Red">Red</option>
          <option value="Green">Green</option>
          <option value="Yellow">Yellow</option>
          <option value="Gray">Gray</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Price <span class="text-red-500">*</span></label>
        <input type="number" name="price[]" step="0.01" min="0" required
               class="w-full px-4 py-2 border rounded-lg" placeholder="0.00">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Stock <span class="text-red-500">*</span></label>
        <input type="number" name="stock[]" min="0" required
               class="w-full px-4 py-2 border rounded-lg" placeholder="0">
      </div>
    </div>
  `;
  container.appendChild(div);
}
</script>

{% endblock %}