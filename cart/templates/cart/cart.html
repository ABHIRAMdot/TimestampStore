{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart - Timestamp{% endblock %}

{% block content %}

<!-- Breadcrumb -->
<nav class="text-sm text-gray-600 mb-8 flex items-center gap-2">
    {% for crumb in breadcrumbs %}
        {% if crumb.url %}
            <a href="{{ crumb.url }}" class="hover:text-blue-600 transition">{{ crumb.label }}</a>
        {% else %}
            <span class="text-gray-900 font-medium">{{ crumb.label }}</span>
        {% endif %}

        {% if not forloop.last %}
            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                      d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z"/>
            </svg>
        {% endif %}
    {% endfor %}
</nav>


<div class="container mx-auto my-10 px-4">
    <h2 class="text-2xl font-semibold mb-6">Shopping Cart</h2>

    {% if messages %}
        {% for message in messages %}
            <div class="p-4 mb-4 rounded border 
                        {% if message.tags == 'success' %}bg-green-100 border-green-300 text-green-800
                        {% elif message.tags == 'error' %}bg-red-100 border-red-300 text-red-800
                        {% elif message.tags == 'warning' %}bg-yellow-100 border-yellow-300 text-yellow-800
                        {% else %}bg-gray-100 border-gray-300 text-gray-800{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    {% if cart_items %}
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Cart Items -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded shadow p-6">
                
                {% for item in cart_items %}

            <!-- inside for loop -->
            <div class="flex flex-col md:flex-row items-start gap-4 pb-6 mb-6 border-b" id="cart-item-{{ item.id }}">
                <!-- Image (clickable) -->
                <div class="w-24 h-24 flex-shrink-0">
                    <a
                    {% if not item.unavailable %}
                    href="{% url 'product_detail' item.product.slug %}" 
                    {% else %}
                    href="javascript:void(0)"
                    class="block opacity-50 cursor-not-allowed"
                {% endif %}
                    >
                        {% if item.variant.images.all %}
                            <img src="{{ item.variant.images.first.image.url }}" 
                                alt="{{ item.product.product_name }}"
                                class="w-full h-full object-cover rounded">
                        {% else %}
                            <div class="w-full h-full flex items-center justify-center bg-gray-100 rounded text-gray-400">
                                No Image
                            </div>
                        {% endif %}
                    </a>
                </div>

    <!-- Product Details -->
    <div class="flex-1">
        <a href="{% url 'product_detail' item.product.slug %}" class="text-sm font-medium hover:text-blue-600">
            {{ item.product.product_name }}
        </a>
        <p class="text-gray-500 text-sm">Color: {{ item.variant.colour }}</p>

        {% if item.unavailable %}
    <span class="inline-block mt-2 px-2 py-1 bg-red-600 text-white rounded text-xs">
        This product is currently unavailable
    </span>
{% endif %}


        {% if not item.is_product_available %}
            <span class="inline-block mt-2 px-2 py-1 bg-red-500 text-white rounded text-xs">Unavailable</span>
        {% elif not item.is_in_stock %}
            <span class="inline-block mt-2 px-2 py-1 bg-yellow-500 text-gray-800 rounded text-xs">Out of Stock</span>
        {% elif item.quantity > item.get_available_stock %}
            <span class="inline-block mt-2 px-2 py-1 bg-yellow-500 text-gray-800 rounded text-xs">
                Only {{ item.get_available_stock }} available
            </span>
        {% endif %}
    </div>

    <!-- Quantity Controls (AJAX) -->
    <div class="flex items-center gap-2">
        <button type="button"
                onclick="updateQtyAjax({{ item.id }}, 'decrease', this)"
                data-cart-item-id="{{ item.id }}"
                class="px-3 py-1 border text-gray-600 rounded disabled:opacity-50"
                id="decrease-btn-{{ item.id }}"
                {% if item.unavailable %} disabled {% endif %}>
            <i class="fas fa-minus"></i>
        </button>

        <div id="qty-display-{{ item.id }}" class="px-3 py-1 border rounded bg-gray-50 text-center w-12">
            {{ item.quantity }}
        </div>

        <button type="button"
                onclick="updateQtyAjax({{ item.id }}, 'increase', this)"
                data-cart-item-id="{{ item.id }}"
                class="px-3 py-1 border text-gray-600 rounded disabled:opacity-50"
                id="increase-btn-{{ item.id }}"
                {% if item.unavailable %} disabled {% endif %}>
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Pricing -->
    <div class="text-right w-36">
        <div id="item-subtotal-{{ item.id }}" class="font-semibold">₹{{ item.get_subtotal }}</div>
        <div class="text-gray-500 text-sm">₹{{ item.price }} each</div>
    </div>

    <!-- Remove -->
    <div>
        <button type="button"
                onclick="confirmRemoveModal({{ item.id }}, '{{ item.product.product_name|escapejs }}')"
                class="px-2 py-1 border border-red-500 text-red-500 rounded hover:bg-red-50">
            <i class="fas fa-trash"></i>
        </button>
    </div>
</div>


                {% endfor %}

                <!-- Clear Cart -->
                <div class="text-right">
                    <button type="button" onclick="confirmClearCart()"
                    class="px-3 py-2 inline-block border border-red-500 text-red-500 hover:bg-red-50 rounded">
                    <i class="fas fa-trash-alt"></i> Clear Cart
                 </button>
                </div>
            </div>
        </div>

        <!-- Summary -->
        <div>
            <div class="bg-white rounded shadow p-6">
                <h5 class="text-lg font-semibold mb-4">Order Summary</h5>

                <div class="flex justify-between mb-2 text-sm">
                    <span>Subtotal ({{ cart_count }} items)</span>
                    <span data-cart-total>₹{{ cart.total }}</span>
                </div>

                <div class="flex justify-between mb-2 text-sm">
                    <span>Shipping</span>
                    <span class="text-green-600">FREE</span>
                </div>

                <hr class="my-3">

                <div class="flex justify-between text-lg font-semibold mb-4">
                    <span>Total</span>
                    <span>₹{{ cart.total }}</span>
                </div>

                {% if any_unavailable %}
                <button class="w-full bg-gray-300 text-gray-500 py-2 rounded cursor-not-allowed" disabled>
                    Remove unavailable items to continue
                </button>
            {% else %}

                <form method="POST" action="{% url 'checkout' %}">   <!--{% url 'proceed_to_checkout' %} -->
                    {% csrf_token %}
                    <button type="submit"
                        class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">
                        Proceed to Checkout
                    </button>
                </form>

                {% endif %}


                <a href="{% url 'user_product_list' %}" 
                   class="w-full mt-3 inline-block text-center border py-2 rounded hover:bg-gray-100">
                    Continue Shopping
                </a>
            </div>

            <div class="mt-4 bg-blue-50 text-blue-700 p-3 rounded text-sm">
                <i class="fas fa-info-circle"></i>
                Maximum {{ cart_items.0.MAX_QUANTITY_PER_PRODUCT }} items per product allowed.
            </div>
        </div>

    </div>

    {% else %}

    <!-- Empty Cart -->
    <div class="text-center py-20">
        <i class="fas fa-shopping-cart text-gray-400 text-6xl mb-4"></i>
        <h4 class="text-xl font-semibold mb-2">Your cart is empty</h4>
        <p class="text-gray-500 mb-6">Looks like you haven't added anything yet.</p>
        <a href="{% url 'user_product_list' %}" 
           class="bg-blue-600 text-white px-5 py-2 rounded hover:bg-blue-700">
            <i class="fas fa-shopping-bag"></i> Start Shopping
        </a>
    </div>

    {% endif %}
</div>

<!-- Confirmation Modal -->
<div id="confirmModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-lg max-w-lg w-full p-6">
      <h3 class="text-lg font-semibold mb-3" id="confirmModalTitle">Confirm</h3>
      <p id="confirmModalMessage" class="text-sm text-gray-600 mb-4">Are you sure?</p>
  
      <div class="flex justify-end gap-3">
        <button type="button" class="px-4 py-2 rounded bg-gray-100" onclick="closeConfirmModal()">Cancel</button>
        <button type="button" id="confirmModalActionBtn" class="px-4 py-2 rounded bg-red-600 text-white">Remove</button>
      </div>
    </div>
  </div>
  
{% endblock %}
